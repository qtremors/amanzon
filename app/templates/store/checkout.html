{% extends 'base.html' %}

{% block title %}Checkout - Amanzon{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row g-5">
        <!-- Billing Form -->
        <div class="col-lg-7">
            <h4 class="fw-bold mb-4">Billing Details</h4>

            {% if saved_addresses %}
            <!-- Saved Addresses Selector -->
            <div class="bg-light p-3 rounded-3 mb-4">
                <label class="form-label small fw-bold text-secondary text-uppercase">Use Saved Address</label>
                <div class="d-flex flex-wrap gap-2">
                    {% for addr in saved_addresses %}
                    <a href="?address={{ addr.id }}"
                        class="btn btn-sm {% if selected_address.id == addr.id %}btn-primary{% else %}btn-outline-secondary{% endif %} rounded-pill">
                        {{ addr.label }}{% if addr.is_default %} ⭐{% endif %}
                    </a>
                    {% endfor %}
                    <a href="{% url 'store:add_address' %}?next={% url 'store:checkout' %}"
                        class="btn btn-sm btn-outline-primary rounded-pill">
                        <i class="bi bi-plus"></i> New
                    </a>
                </div>
            </div>
            {% endif %}

            <div class="bg-white p-4 rounded-4 shadow-sm border border-subtle">
                <form id="checkout-form" method="POST">
                    {% csrf_token %}

                    <!-- Save address checkbox for new users -->
                    {% if not saved_addresses %}
                    <div class="form-check mb-3">
                        <input type="checkbox" class="form-check-input" id="save_address" name="save_address" checked>
                        <label class="form-check-label" for="save_address">Save this address for future orders</label>
                    </div>
                    {% endif %}

                    <div class="row g-3">
                        <h6 class="text-secondary small text-uppercase tracking-wide fw-bold mb-0 mt-2">Contact Info
                        </h6>
                        <div class="col-md-6">
                            <label for="id_first_name" class="form-label small fw-bold">First Name</label>
                            {{ form.first_name }}
                        </div>
                        <div class="col-md-6">
                            <label for="id_last_name" class="form-label small fw-bold">Last Name</label>
                            {{ form.last_name }}
                        </div>
                        <div class="col-md-6">
                            <label for="id_email" class="form-label small fw-bold">Email</label>
                            {{ form.email }}
                        </div>
                        <div class="col-md-6">
                            <label for="id_phone" class="form-label small fw-bold">Phone</label>
                            {{ form.phone }}
                        </div>

                        <div class="col-12 mt-4">
                            <h6 class="text-secondary small text-uppercase tracking-wide fw-bold mb-1">Shipping Address
                            </h6>
                        </div>
                        <div class="col-12">
                            <label for="id_address_line1" class="form-label small fw-bold">Address Line 1</label>
                            {{ form.address_line1 }}
                        </div>
                        <div class="col-12">
                            <label for="id_address_line2" class="form-label small fw-bold">Address Line 2 <span
                                    class="text-muted fw-normal">(Optional)</span></label>
                            {{ form.address_line2 }}
                        </div>
                        <div class="col-md-6">
                            <label for="id_city" class="form-label small fw-bold">City</label>
                            {{ form.city }}
                        </div>
                        <div class="col-md-6">
                            <label for="id_state" class="form-label small fw-bold">State</label>
                            {{ form.state }}
                        </div>
                        <div class="col-md-6">
                            <label for="id_country" class="form-label small fw-bold">Country</label>
                            {{ form.country }}
                        </div>
                        <div class="col-md-6">
                            <label for="id_zip_code" class="form-label small fw-bold">ZIP Code</label>
                            {{ form.zip_code }}
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- Order Summary -->
        <div class="col-lg-5">
            <h4 class="fw-bold mb-4">Your Order</h4>
            <div class="bg-light p-4 rounded-4 sticky-top" style="top: 100px;">
                <div class="d-flex flex-column gap-3 mb-4">
                    {% for item in cart_items %}
                    <div class="d-flex align-items-center justify-content-between">
                        <div class="d-flex align-items-center gap-3">
                            <div class="position-relative">
                                <img src="{{ item.product.image.url }}" alt="{{ item.product.name }}" class="rounded"
                                    style="width: 50px; height: 50px; object-fit: cover;">
                                <span
                                    class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-secondary text-white"
                                    style="font-size: 0.7rem;">
                                    {{ item.quantity }}
                                </span>
                            </div>
                            <div>
                                <h6 class="mb-0 small fw-bold text-dark">{{ item.product.name }}</h6>
                                <small class="text-secondary">{{ item.product.category.name }}</small>
                            </div>
                        </div>
                        <span class="fw-medium small">₹{{ item.total_price }}</span>
                    </div>
                    {% endfor %}
                </div>

                <hr class="border-secondary opacity-10">

                <div class="d-flex justify-content-between mb-2 text-secondary small">
                    <span>Subtotal</span>
                    <span>₹{{ subtotal }}</span>
                </div>
                {% if discount > 0 %}
                <div class="d-flex justify-content-between mb-2 text-success small">
                    <span>Discount</span>
                    <span>-₹{{ discount }}</span>
                </div>
                {% endif %}
                <div class="d-flex justify-content-between mb-4 text-secondary small">
                    <span>Shipping</span>
                    <span>₹{{ shipping }}</span>
                </div>

                <div
                    class="d-flex justify-content-between align-items-center border-top border-secondary border-opacity-10 pt-3 mb-4">
                    <span class="fw-bold fs-5">Total</span>
                    <span class="fw-bold fs-4 text-primary">₹{{ total }}</span>
                </div>

                {% if demo_mode %}
                <div class="alert alert-warning small mb-3">
                    <i class="bi bi-exclamation-circle-fill me-1"></i> Demo Mode Active: No actual payment will be
                    processed.
                </div>
                {% endif %}

                <button id="pay-button" class="btn btn-primary w-100 py-3 rounded-pill fw-bold shadow-sm">
                    {% if demo_mode %}Execute Demo Payment{% else %}Pay ₹{{ total }} Securely{% endif %}
                </button>
                <div class="text-center mt-3">
                    <small class="text-muted"><i class="bi bi-lock-fill me-1"></i> Secured by Razorpay</small>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<style>
    .is-invalid {
        border-color: #dc3545 !important;
    }

    .invalid-feedback {
        display: none;
        color: #dc3545;
        font-size: 0.875rem;
        margin-top: 0.25rem;
    }

    .is-invalid+.invalid-feedback,
    .is-invalid~.invalid-feedback {
        display: block;
    }

    .btn-loading {
        pointer-events: none;
        opacity: 0.7;
    }

    .spinner-border-sm {
        width: 1rem;
        height: 1rem;
        border-width: 0.15em;
    }
</style>
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script>
    document.getElementById('pay-button').addEventListener('click', function (e) {
        e.preventDefault();
        var btn = this;

        // Validate billing form before opening payment
        var form = document.getElementById('checkout-form');
        var requiredFields = ['first_name', 'last_name', 'email', 'phone', 'address_line1', 'city', 'state', 'country', 'zip_code'];
        var isValid = true;

        // Clear previous validation
        form.querySelectorAll('.is-invalid').forEach(function (el) {
            el.classList.remove('is-invalid');
        });

        requiredFields.forEach(function (fieldName) {
            var field = form.querySelector('[name="' + fieldName + '"]');
            if (field && !field.value.trim()) {
                field.classList.add('is-invalid');
                // Add feedback message if not exists
                if (!field.nextElementSibling || !field.nextElementSibling.classList.contains('invalid-feedback')) {
                    var feedback = document.createElement('div');
                    feedback.className = 'invalid-feedback';
                    feedback.textContent = 'This field is required';
                    field.parentNode.insertBefore(feedback, field.nextSibling);
                }
                isValid = false;
            }
        });

        // Email validation
        var emailField = form.querySelector('[name="email"]');
        if (emailField && emailField.value && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(emailField.value)) {
            emailField.classList.add('is-invalid');
            isValid = false;
        }

        if (!isValid) {
            form.scrollIntoView({ behavior: 'smooth', block: 'center' });
            return;
        }

        // Show loading state
        var originalText = btn.innerHTML;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Processing...';
        btn.classList.add('btn-loading');

        // Get current form values for prefill
        var firstName = form.querySelector('[name="first_name"]').value;
        var lastName = form.querySelector('[name="last_name"]').value;
        var email = form.querySelector('[name="email"]').value;
        var phone = form.querySelector('[name="phone"]').value;

        var options = {
            "key": "{{ razorpay_key }}",
            "amount": "{{ razorpay_order.amount }}",
            "currency": "{{ razorpay_order.currency }}",
            "name": "Amanzon",
            "description": "Payment for Order",
            "order_id": "{{ razorpay_order.id }}",
            "handler": function (response) {
                // Keep loading state during form submission
                btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Completing Order...';

                // Add billing data to the payment callback form
                var paymentForm = document.createElement('form');
                paymentForm.method = 'POST';
                paymentForm.action = '{% url "store:payment_callback" %}';

                var csrfInput = document.createElement('input');
                csrfInput.type = 'hidden';
                csrfInput.name = 'csrfmiddlewaretoken';
                csrfInput.value = '{{ csrf_token }}';
                paymentForm.appendChild(csrfInput);

                // Add Razorpay payment details
                var fields = {
                    'razorpay_payment_id': response.razorpay_payment_id,
                    'razorpay_order_id': response.razorpay_order_id,
                    'razorpay_signature': response.razorpay_signature
                };

                for (var key in fields) {
                    var input = document.createElement('input');
                    input.type = 'hidden';
                    input.name = key;
                    input.value = fields[key];
                    paymentForm.appendChild(input);
                }

                // Add billing details from the main form
                var billingFields = ['first_name', 'last_name', 'email', 'phone', 'address_line1', 'address_line2', 'city', 'state', 'country', 'zip_code'];
                billingFields.forEach(function (fieldName) {
                    var input = document.createElement('input');
                    input.type = 'hidden';
                    input.name = 'billing_' + fieldName;
                    var field = form.querySelector('[name="' + fieldName + '"]');
                    if (field) {
                        input.value = field.value;
                    }
                    paymentForm.appendChild(input);
                });

                document.body.appendChild(paymentForm);
                paymentForm.submit();
            },
            "prefill": {
                "name": firstName + " " + lastName,
                "email": email,
                "contact": phone
            },
            "theme": {
                "color": "#0d6efd"
            },
            "modal": {
                "ondismiss": function () {
                    btn.innerHTML = originalText;
                    btn.classList.remove('btn-loading');
                }
            }
        };

        // Check for Demo Mode
        var isDemoMode = "{{ demo_mode }}" === "True";

        if (isDemoMode) {
            // Simulate payment flow
            setTimeout(function () {
                var mockResponse = {
                    razorpay_payment_id: 'pay_demo_' + Math.random().toString(36).substr(2, 9),
                    razorpay_order_id: "{{ razorpay_order.id }}",
                    razorpay_signature: 'demo_signature'
                };
                options.handler(mockResponse);
            }, 1500); // 1.5s delay to simulate processing
        } else {
            // Initialize Razorpay
            var rzp1 = new Razorpay(options);
            rzp1.on('payment.failed', function (response) {
                alert('Payment Failed: ' + response.error.description);
                btn.innerHTML = originalText;
                btn.classList.remove('btn-loading');
            });
            rzp1.open();
        }
    });

    // Real-time validation on blur
    document.getElementById('checkout-form').querySelectorAll('input').forEach(function (input) {
        input.addEventListener('blur', function () {
            if (this.value.trim()) {
                this.classList.remove('is-invalid');
            }
        });
    });
</script>
{% endblock %}